# Перевод системного промпта

## Проблема

Системный промпт во вкладке "Processing" всегда показывался на русском языке, даже после переключения на английский.

## Решение

### 1. Добавлены переводы дефолтного промпта

**English (`utils/translations/en.json`):**
```json
"settings": {
  "processing": {
    "prompt_default": "You are a text editor. Your task: fix grammatical errors, add punctuation and improve text readability. Preserve the original meaning and style. Don't add anything extra. Return only the corrected text without comments."
  }
}
```

**Russian (`utils/translations/ru.json`):**
```json
"settings": {
  "processing": {
    "prompt_default": "Ты - редактор текста. Твоя задача: исправить грамматические ошибки, добавить знаки препинания и улучшить читаемость текста. Сохрани оригинальный смысл и стиль. Не добавляй ничего лишнего. Верни только исправленный текст без комментариев."
  }
}
```

### 2. Обновлен Config класс

В `core/config.py` дефолтный промпт теперь использует перевод:

**Было:**
```python
self.post_processing_prompt: str = (
    "Ты - редактор текста. Твоя задача: исправить грамматические ошибки, "
    "добавить знаки препинания и улучшить читаемость текста. "
    "Сохрани оригинальный смысл и стиль. Не добавляй ничего лишнего. "
    "Верни только исправленный текст без комментариев."
)
```

**Стало:**
```python
from utils.i18n import t
self.post_processing_prompt: str = t("settings.processing.prompt_default")
```

### 3. Добавлена умная замена промпта при смене языка

В `ui/settings_window.py` добавлен метод `_is_default_prompt()`:

```python
def _is_default_prompt(self, prompt: str) -> bool:
    """Проверяет, является ли промпт дефолтным на любом языке."""
    default_prompts = [
        # English
        "You are a text editor. Your task: fix grammatical errors...",
        # Russian
        "Ты - редактор текста. Твоя задача: исправить грамматические ошибки...",
    ]
    
    prompt_stripped = prompt.strip()
    return any(prompt_stripped == default.strip() for default in default_prompts)
```

### 4. Обновлен метод `_restore_current_values()`

При восстановлении значений после смены языка:

```python
# Проверить, является ли промпт дефолтным на любом языке
current_prompt = values['post_processing_prompt']
is_default_prompt = self._is_default_prompt(current_prompt)

if is_default_prompt:
    # Если промпт дефолтный, заменить на переведенную версию
    self.post_processing_prompt_edit.setPlainText(t("settings.processing.prompt_default"))
else:
    # Если промпт изменен пользователем, оставить как есть
    self.post_processing_prompt_edit.setPlainText(current_prompt)
```

## Как это работает

### Сценарий 1: Дефолтный промпт

1. Пользователь открывает настройки
2. Видит дефолтный промпт на текущем языке (например, русский)
3. Меняет язык на английский
4. Нажимает "Save"
5. ✅ Промпт автоматически заменяется на английскую версию

### Сценарий 2: Пользовательский промпт

1. Пользователь изменил промпт (добавил свой текст)
2. Меняет язык на английский
3. Нажимает "Save"
4. ✅ Промпт остается без изменений (пользовательский текст не переводится)

## Тестирование

### Тест 1: Дефолтный промпт переводится

1. Откройте настройки → Processing
2. Убедитесь что промпт дефолтный (не изменяли его)
3. Перейдите на Languages → выберите English
4. Нажмите "Save"
5. Вернитесь на Processing
6. ✅ Промпт должен быть на английском

### Тест 2: Пользовательский промпт не переводится

1. Откройте настройки → Processing
2. Измените промпт (добавьте свой текст)
3. Перейдите на Languages → выберите English
4. Нажмите "Save"
5. Вернитесь на Processing
6. ✅ Промпт должен остаться без изменений (ваш текст)

### Тест 3: Новая установка

1. Удалите `.env` файл
2. Запустите приложение
3. Откройте настройки
4. ✅ Промпт должен быть на языке системы (или английском по умолчанию)

## Что работает

✅ Дефолтный промпт переводится при смене языка  
✅ Пользовательский промпт не переводится (правильное поведение)  
✅ Новые установки получают промпт на правильном языке  
✅ Промпт корректно определяется как дефолтный на любом языке  
✅ Label и placeholder уже были переведены ранее  

## Важно

⚠️ Если пользователь изменил промпт, он НЕ будет автоматически переведен при смене языка. Это правильное поведение - пользовательский текст не должен автоматически переводиться.

Если нужно вернуть дефолтный промпт:
1. Удалите весь текст в поле промпта
2. Закройте и откройте настройки снова
3. Или скопируйте дефолтный промпт из placeholder
