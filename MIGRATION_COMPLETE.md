# ✅ Миграция завершена: Сохранение настроек исправлено

## Проблема решена

**Проблема**: После миграции с `.env` на `config.jsonc` все настройки пропадали при изменении через UI, потому что приложение загружало из нового формата, но сохраняло в старый.

**Решение**: Все места сохранения настроек обновлены для использования `config.jsonc` и `secrets.json`.

## Что изменилось

### ✅ Исправлено сохранение настроек

Теперь ВСЕ изменения через UI корректно сохраняются:

1. **Основные настройки** (кнопка "Сохранить" в настройках):
   - Провайдер AI, модель, hotkey
   - Настройки аудио (порог тишины, длительность и т.д.)
   - Настройки окна (прозрачность, размеры шрифтов, позиция)
   - Настройки записи (сохранять записи, путь к папке)
   - Пост-обработка (включено, провайдер, модель, промпт)
   - Язык интерфейса
   - **API ключи** → сохраняются в `secrets.json`

2. **Настройки форматирования**:
   - Включено/выключено
   - Провайдер, модель, temperature
   - Список приложений
   - Промпты для каждого приложения → сохраняются в `config/prompts/*.txt`
   - Ключевые слова для веб-приложений
   - **API ключ custom провайдера** → сохраняется в `secrets.json`

3. **Позиция окна**:
   - Автоматически сохраняется при перетаскивании окна
   - Сохраняется в `config.jsonc` по пути `window.position_x/y`

4. **Язык интерфейса**:
   - Сохраняется при переключении языка
   - Сохраняется в `config.jsonc` по пути `localization.language`

5. **Папка записей**:
   - Сохраняется при изменении через кнопку "Изменить папку"
   - Сохраняется при сбросе на значение по умолчанию
   - Сохраняется в `config.jsonc` по пути `recording.recordings_path`

## Структура файлов

```
config.jsonc          # Все публичные настройки (в .gitignore)
secrets.json          # API ключи (в .gitignore)
config/prompts/*.txt  # Промпты форматирования (в git)

config.jsonc.example  # Пример конфигурации (в git)
secrets.json.example  # Пример секретов (в git)
```

## Проверка работы

Чтобы убедиться, что всё работает:

1. **Откройте настройки** и измените любую настройку (например, прозрачность окна)
2. **Нажмите "Сохранить"**
3. **Закройте приложение**
4. **Откройте снова** - настройки должны сохраниться

## Технические детали

### Обновлённые файлы

1. `services/formatting_config.py`:
   - Добавлен метод `save_to_config()` для сохранения в новый формат
   - Метод `save_to_env()` теперь вызывает `save_to_config()` по умолчанию

2. `core/config_saver.py`:
   - Добавлен метод `update_multiple_values()` для эффективного сохранения

3. `ui/settings_window.py`:
   - Метод `_save_settings()` полностью переписан
   - Использует `ConfigSaver` вместо прямой записи в `.env`

4. `ui/floating_window.py`:
   - Метод `save_position()` использует `ConfigSaver`

5. `utils/i18n.py`:
   - Функция `set_language()` использует `ConfigSaver`

### Обратная совместимость

- Тесты продолжают работать (используют явный путь к `.env`)
- Метод `save_to_env()` сохранён для тестов
- При вызове без параметров автоматически использует новый формат

## Что дальше

Теперь можно безопасно:
- Изменять любые настройки через UI
- Перезапускать приложение - всё сохранится
- Делиться `config.jsonc.example` и `secrets.json.example` в git
- Держать свои настройки и ключи в `.gitignore`

## Если что-то пошло не так

Если настройки всё ещё не сохраняются:

1. Проверьте, что файлы существуют:
   - `config.jsonc`
   - `secrets.json`

2. Проверьте права на запись в эти файлы

3. Проверьте логи в `rapidwhisper.log` - там будут сообщения о сохранении

4. Если нужно, запустите миграцию заново:
   ```bash
   uv run python migrate_to_jsonc.py
   ```

## Документация

- `SAVE_TO_CONFIG_MIGRATION.md` - подробное описание изменений
- `CONFIG_MIGRATION.md` - документация по миграции с `.env`
- `CONFIG_README.md` - общая документация по конфигурации
