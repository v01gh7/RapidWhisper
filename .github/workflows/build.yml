name: Build RapidWhisper

on:
  push:
    tags:
      - 'v*.*.*'  # Запуск при создании тега вида v1.0.0
  workflow_dispatch:  # Запуск только вручную
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      run: |
        pip install uv

    - name: Create virtual environment and install dependencies
      run: |
        uv venv
        uv pip install -r requirements-windows.txt

    - name: Verify files
      run: |
        echo "Current directory:"
        pwd
        echo "Files in current directory:"
        dir
        echo "Checking for RapidWhisper.spec:"
        if (Test-Path "RapidWhisper.spec") { echo "RapidWhisper.spec found" } else { echo "RapidWhisper.spec NOT found"; exit 1 }

    - name: Build Windows executable
      run: |
        uv run pyinstaller RapidWhisper.spec --clean

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: RapidWhisper-Windows
        path: dist/RapidWhisper.exe
        retention-days: 30

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install system dependencies
      run: |
        brew install portaudio

    - name: Install uv
      run: |
        pip install uv

    - name: Create virtual environment and install dependencies
      run: |
        uv venv
        uv pip install -r requirements-macos.txt

    - name: Verify files
      run: |
        echo "Current directory:"
        pwd
        echo "Files in current directory:"
        ls -la
        echo "Checking for RapidWhisper-macOS.spec:"
        if [ -f "RapidWhisper-macOS.spec" ]; then echo "RapidWhisper-macOS.spec found"; else echo "RapidWhisper-macOS.spec NOT found"; exit 1; fi

    - name: Build macOS executable
      run: |
        source .venv/bin/activate
        pyinstaller RapidWhisper-macOS.spec --clean

    - name: Create DMG
      run: |
        # Создать .app bundle
        mkdir -p "dist/RapidWhisper.app/Contents/MacOS"
        mv dist/RapidWhisper "dist/RapidWhisper.app/Contents/MacOS/"

        # Создать Info.plist
        cat > "dist/RapidWhisper.app/Contents/Info.plist" << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>RapidWhisper</string>
            <key>CFBundleIdentifier</key>
            <string>com.rapidwhisper.app</string>
            <key>CFBundleName</key>
            <string>RapidWhisper</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
        </dict>
        </plist>
        EOF

        # Создать DMG
        hdiutil create -volname "RapidWhisper" -srcfolder "dist/RapidWhisper.app" -ov -format UDZO "dist/RapidWhisper-macOS.dmg"

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: RapidWhisper-macOS
        path: dist/RapidWhisper-macOS.dmg
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y portaudio19-dev python3-pyqt6 xdotool wmctrl

    - name: Install uv
      run: |
        pip install uv

    - name: Create virtual environment and install dependencies
      run: |
        uv venv
        uv pip install -r requirements-linux.txt

    - name: Verify files
      run: |
        echo "Current directory:"
        pwd
        echo "Files in current directory:"
        ls -la
        echo "Checking for RapidWhisper-Linux.spec:"
        if [ -f "RapidWhisper-Linux.spec" ]; then echo "RapidWhisper-Linux.spec found"; else echo "RapidWhisper-Linux.spec NOT found"; exit 1; fi

    - name: Build Linux executable
      run: |
        source .venv/bin/activate
        pyinstaller RapidWhisper-Linux.spec --clean

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: RapidWhisper-Linux
        path: dist/RapidWhisper
        retention-days: 30

  # Создать релиз (автоматически при теге, или вручную с выбором)
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.create_release == 'true')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Display structure of downloaded files
      run: ls -R

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          RapidWhisper-Windows/RapidWhisper.exe
          RapidWhisper-macOS/RapidWhisper-macOS.dmg
          RapidWhisper-Linux/RapidWhisper
        draft: false
        prerelease: false
        generate_release_notes: true
        name: Release ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
