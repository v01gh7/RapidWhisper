# План Реализации: RapidWhisper

## Обзор

Этот план разбивает проектирование RapidWhisper на дискретные задачи по кодированию. Каждая задача строится на предыдущих шагах и включает инкрементальную валидацию через тесты. Приложение будет реализовано на Python 3.11+ с использованием PyQt6, PyAudio и OpenAI SDK для интеграции с GLM API. we are using uv manger, if activated envr, dont activate


## Задачи

- [x] 1. Настройка проекта и базовой инфраструктуры
  - Создать структуру директорий проекта (core/, ui/, services/, models/, utils/, tests/)
  - Настроить pyproject.toml для uv с зависимостями (PyQt6, PyAudio, openai, pyperclip, keyboard, numpy, python-dotenv, pytest, hypothesis)
  - Создать .env.example с шаблоном для GLM_API_KEY
  - Создать .gitignore для Python проекта
  - Настроить базовое логирование в utils/logger.py
  - _Requirements: 12.1, 12.5_

- [ ] 2. Реализация моделей данных и конфигурации
  - [x] 2.1 Создать модели данных в models/data_models.py
    - Реализовать dataclass AudioData с методом save_to_file
    - Реализовать dataclass TranscriptionResult с методом get_preview
    - Реализовать dataclass ErrorInfo с методом log_to_file
    - _Requirements: 3.2, 3.3, 8.3_
  
  - [x] 2.2 Написать unit-тесты для моделей данных
    - Тест сохранения AudioData в WAV файл
    - Тест усечения текста в TranscriptionResult.get_preview
    - Тест логирования ErrorInfo
    - _Requirements: 3.2, 8.3, 10.5_
  
  - [x] 2.3 Создать систему конфигурации в core/config.py
    - Реализовать класс Config с загрузкой из .env
    - Реализовать метод load_from_env() с использованием python-dotenv
    - Реализовать метод validate() для проверки обязательных параметров
    - Поддержать значения по умолчанию для всех параметров
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_
  
  - [x] 2.4 Написать property-тест для конфигурации
    - **Property 32: Настраиваемость параметров**
    - **Property 33: Значения по умолчанию**
    - **Validates: Requirements 11.2, 11.3, 11.4, 11.5**

- [x] 3. Реализация иерархии исключений и обработки ошибок
  - Создать базовый класс RapidWhisperError в utils/exceptions.py
  - Реализовать специализированные исключения (AudioError, APIError, ConfigurationError и их подклассы)
  - Создать ErrorLogger в utils/logger.py с методом log_error
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 4. Реализация аудио движка
  - [x] 4.1 Создать AudioEngine в services/audio_engine.py
    - Реализовать инициализацию PyAudio с параметрами (16000 Hz, моно, int16)
    - Реализовать метод start_recording() для начала записи
    - Реализовать метод stop_recording() для остановки и сохранения в WAV
    - Реализовать метод get_current_rms() для вычисления громкости
    - Реализовать _audio_callback для обработки аудио потока
    - Реализовать _save_to_wav для сохранения буфера в файл
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [x] 4.2 Написать unit-тесты для AudioEngine
    - Тест инициализации с правильными параметрами
    - Тест создания WAV файла после остановки записи
    - Тест обработки ошибки недоступного микрофона
    - Тест обработки слишком короткой записи
    - _Requirements: 3.2, 3.5, 3.6, 10.3_
  
  - [x] 4.3 Написать property-тест для вычисления RMS
    - **Property 8: Корректность вычисления RMS**
    - **Validates: Requirements 4.3**
  
  - [x] 4.4 Написать property-тест для роста буфера
    - **Property 5: Рост аудио буфера**
    - **Validates: Requirements 3.4**

- [x] 5. Реализация детектора тишины
  - [x] 5.1 Создать SilenceDetector в services/silence_detector.py
    - Реализовать инициализацию с порогом и длительностью тишины
    - Реализовать метод update(rms, timestamp) для анализа громкости
    - Реализовать метод calibrate_background_noise для адаптивного порога
    - Реализовать метод reset() для сброса состояния
    - Реализовать логику debouncing для игнорирования коротких пауз
    - _Requirements: 5.1, 5.2, 5.3, 5.4_
  
  - [x] 5.2 Написать property-тесты для детектора тишины
    - **Property 11: Непрерывный анализ громкости**
    - **Property 12: Обнаружение тишины по времени**
    - **Property 13: Адаптивный порог тишины**
    - **Property 14: Игнорирование коротких пауз**
    - **Validates: Requirements 5.1, 5.2, 5.3, 5.4**

- [x] 6. Checkpoint - Проверка аудио подсистемы
  - Убедиться, что все тесты аудио компонентов проходят
  - Проверить, что AudioEngine корректно записывает и сохраняет аудио
  - Проверить, что SilenceDetector корректно определяет тишину
  - Спросить пользователя, если возникли вопросы

- [x] 7. Реализация GLM API клиента
  - [x] 7.1 Создать GLMClient в services/glm_client.py
    - Реализовать инициализацию OpenAI клиента с base_url для Zhipu AI
    - Реализовать метод transcribe_audio(audio_file_path) для транскрипции
    - Реализовать метод _prepare_audio_file для подготовки файла
    - Реализовать метод _handle_api_error для обработки ошибок API
    - Добавить обработку AuthenticationError, APIConnectionError, APITimeoutError
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8_
  
  - [x] 7.2 Написать unit-тесты для GLMClient
    - Тест загрузки API ключа из переменной окружения
    - Тест извлечения текста из mock ответа API
    - Тест обработки ошибки аутентификации
    - Тест обработки сетевой ошибки
    - Тест обработки таймаута
    - _Requirements: 6.2, 6.6, 6.7, 6.8_
  
  - [x] 7.3 Написать property-тесты для GLMClient
    - **Property 16: Извлечение текста из ответа API**
    - **Property 17: Отправка аудио на транскрипцию**
    - **Validates: Requirements 6.3, 6.6**

- [x] 8. Реализация вспомогательных сервисов
  - [x] 8.1 Создать ClipboardManager в services/clipboard_manager.py
    - Реализовать метод copy_to_clipboard(text) с использованием pyperclip
    - Реализовать метод get_from_clipboard()
    - Добавить обработку ошибок недоступности буфера обмена
    - _Requirements: 8.2_
  
  - [x] 8.2 Написать property-тест для буфера обмена
    - **Property 22: Копирование в буфер обмена**
    - **Validates: Requirements 8.2**
  
  - [x] 8.3 Создать HotkeyManager в services/hotkey_manager.py
    - Реализовать регистрацию глобальной горячей клавиши с использованием keyboard
    - Реализовать метод register_hotkey(key, callback)
    - Реализовать метод unregister_hotkey()
    - Реализовать обработку конфликтов горячих клавиш
    - _Requirements: 1.1, 1.4, 1.5_
  
  - [x] 8.4 Написать property-тест для горячих клавиш
    - **Property 1: Глобальная активация горячей клавиши**
    - **Validates: Requirements 1.2, 1.4**

- [x] 9. Реализация менеджера состояний
  - [x] 9.1 Создать StateManager в core/state_manager.py
    - Реализовать enum AppState с состояниями (IDLE, RECORDING, PROCESSING, DISPLAYING, ERROR)
    - Реализовать класс StateManager с PyQt Signal для state_changed
    - Реализовать метод transition_to(new_state) с валидацией переходов
    - Реализовать обработчики событий (on_hotkey_pressed, on_silence_detected, on_transcription_complete, on_error)
    - Реализовать логику переходов состояний согласно диаграмме
    - Реализовать метод cleanup_resources() для освобождения ресурсов
    - _Requirements: 1.2, 1.3, 5.5, 10.6_
  
  - [x] 9.2 Написать unit-тесты для StateManager
    - Тест переходов между состояниями
    - Тест обработки нажатия горячей клавиши в разных состояниях
    - Тест восстановления после ошибки
    - _Requirements: 1.2, 1.3, 10.6_
  
  - [x] 9.3 Написать property-тесты для переходов состояний
    - **Property 15: Переход к обработке при тишине**
    - **Property 31: Восстановление после ошибки**
    - **Validates: Requirements 5.5, 10.6**

- [~] 10. Checkpoint - Проверка бизнес-логики
  - Убедиться, что все тесты сервисов и менеджера состояний проходят
  - Проверить, что StateManager корректно координирует компоненты
  - Проверить, что обработка ошибок работает правильно
  - Спросить пользователя, если возникли вопросы

- [ ] 11. Реализация виджета визуализации волны
  - [~] 11.1 Создать WaveformWidget в ui/waveform_widget.py
    - Наследовать от QWidget
    - Реализовать инициализацию с QTimer для обновлений (50ms)
    - Реализовать метод update_rms(rms) для обновления данных
    - Реализовать методы start_recording_animation() и start_loading_animation()
    - Реализовать метод stop_animation()
    - Реализовать paintEvent для отрисовки волны или спиннера
    - Реализовать _draw_waveform(painter) для рисования звуковых баров
    - Реализовать _draw_spinner(painter) для рисования индикатора загрузки
    - Реализовать сглаживание значений (exponential smoothing)
    - _Requirements: 4.1, 4.2, 4.4, 4.6, 7.1, 7.2, 7.3_
  
  - [~] 11.2 Написать property-тесты для визуализации
    - **Property 7: Обновление визуализации волны**
    - **Property 9: Пропорциональность амплитуды RMS**
    - **Property 10: Плавность интерполяции**
    - **Property 27: Частота обновления визуализации**
    - **Validates: Requirements 4.1, 4.2, 4.4, 4.6, 9.3**
  
  - [~] 11.3 Написать property-тесты для анимаций
    - **Property 18: Трансформация визуализации**
    - **Property 19: Отображение индикатора во время API запроса**
    - **Property 20: Скрытие индикатора после ответа**
    - **Validates: Requirements 7.1, 7.2, 7.5**

- [ ] 12. Реализация плавающего окна
  - [~] 12.1 Создать FloatingWindow в ui/floating_window.py
    - Наследовать от QWidget
    - Реализовать setup_window_properties() для настройки флагов (FramelessWindowHint, WindowStaysOnTopHint, Tool)
    - Реализовать метод show_at_center() для центрирования на экране
    - Реализовать метод hide_with_animation() с fade-out
    - Реализовать apply_blur_effect() для платформо-зависимого размытия (Windows/macOS/Linux)
    - Реализовать paintEvent для отрисовки скругленного фона
    - Интегрировать WaveformWidget в layout
    - Добавить QLabel для отображения текста и статуса
    - Реализовать стилизацию через QSS (border-radius, background-color)
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_
  
  - [~] 12.2 Написать unit-тесты для FloatingWindow
    - Тест установки правильных флагов окна
    - Тест центрирования окна на экране
    - Тест применения стилей
    - _Requirements: 2.2, 2.4, 2.5, 2.6_
  
  - [~] 12.3 Написать property-тесты для окна
    - **Property 2: Центрирование окна**
    - **Property 3: Анимация прозрачности**
    - **Validates: Requirements 2.2, 2.7, 2.8**

- [ ] 13. Реализация платформо-зависимых эффектов размытия
  - [~] 13.1 Создать platform_utils.py в utils/
    - Реализовать функцию apply_windows_blur(hwnd) для Windows 11 Acrylic
    - Реализовать функцию apply_macos_blur(window) для macOS NSVisualEffectView
    - Реализовать функцию apply_linux_blur(window) для Linux композитинга
    - Реализовать функцию detect_platform() для определения ОС
    - _Requirements: 2.3_
  
  - [~] 13.2 Написать unit-тесты для платформо-зависимых утилит
    - Тест определения платформы
    - Тест применения blur эффекта (с моками для каждой ОС)
    - _Requirements: 2.3_

- [ ] 14. Реализация многопоточности
  - [~] 14.1 Создать AudioRecordingThread в services/audio_engine.py
    - Наследовать от QThread
    - Реализовать сигналы rms_updated и recording_stopped
    - Реализовать метод run() для главного цикла записи
    - Реализовать _callback для обработки аудио чанков
    - Интегрировать с SilenceDetector
    - _Requirements: 4.7, 9.1_
  
  - [~] 14.2 Создать TranscriptionThread в services/glm_client.py
    - Наследовать от QThread
    - Реализовать сигналы transcription_complete и transcription_error
    - Реализовать метод run() для выполнения транскрипции
    - Добавить удаление временного файла в finally блоке
    - _Requirements: 9.2_
  
  - [~] 14.3 Написать property-тесты для многопоточности
    - **Property 26: Многопоточная архитектура**
    - **Property 28: Неблокирующий UI**
    - **Validates: Requirements 9.1, 9.2, 4.7, 9.5**

- [~] 15. Checkpoint - Проверка UI компонентов
  - Убедиться, что все тесты UI компонентов проходят
  - Проверить, что FloatingWindow корректно отображается
  - Проверить, что WaveformWidget корректно анимируется
  - Проверить, что многопоточность работает без блокировки UI
  - Спросить пользователя, если возникли вопросы

- [ ] 16. Реализация главного приложения
  - [~] 16.1 Создать RapidWhisperApp в main.py
    - Реализовать инициализацию QApplication
    - Реализовать метод initialize() для настройки всех компонентов
    - Реализовать метод run() для запуска главного цикла событий
    - Реализовать метод shutdown() для корректного завершения
    - Подключить все сигналы и слоты между компонентами
    - Интегрировать StateManager для координации
    - _Requirements: 12.1, 12.2, 12.6_
  
  - [~] 16.2 Реализовать координацию компонентов
    - Подключить HotkeyManager к StateManager.on_hotkey_pressed
    - Подключить AudioRecordingThread.rms_updated к WaveformWidget.update_rms
    - Подключить SilenceDetector к StateManager.on_silence_detected
    - Подключить TranscriptionThread.transcription_complete к обработчику результата
    - Реализовать обработчик результата транскрипции (отображение, копирование, автоскрытие)
    - _Requirements: 1.2, 4.1, 5.5, 8.1, 8.2, 8.6_
  
  - [~] 16.3 Написать property-тесты для координации
    - **Property 4: Запуск записи при показе окна**
    - **Property 21: Отображение текста в окне**
    - **Property 23: Усечение длинного текста**
    - **Property 24: Автоматическое скрытие окна**
    - **Property 25: Отмена автоскрытия при наведении**
    - **Validates: Requirements 3.1, 8.1, 8.3, 8.6, 8.7**

- [ ] 17. Реализация управления ресурсами и очистки
  - [~] 17.1 Реализовать cleanup_resources() в RapidWhisperApp
    - Остановить и закрыть AudioEngine
    - Отменить регистрацию горячих клавиш
    - Удалить все временные файлы
    - Завершить все активные потоки
    - _Requirements: 12.2, 12.3, 12.4_
  
  - [~] 17.2 Написать property-тесты для управления ресурсами
    - **Property 29: Освобождение ресурсов микрофона**
    - **Property 34: Очистка ресурсов при завершении**
    - **Property 35: Удаление временных файлов**
    - **Property 37: Корректное завершение процесса**
    - **Validates: Requirements 9.6, 12.2, 12.3, 12.4, 12.6**

- [ ] 18. Реализация логирования и отладки
  - [~] 18.1 Расширить ErrorLogger в utils/logger.py
    - Добавить логирование информационных сообщений
    - Добавить логирование переходов состояний
    - Добавить логирование API запросов и ответов
    - Настроить ротацию лог файлов
    - _Requirements: 10.5, 12.5_
  
  - [~] 18.2 Написать property-тест для логирования
    - **Property 30: Логирование ошибок**
    - **Property 36: Сохранение логов**
    - **Validates: Requirements 10.5, 12.5**

- [ ] 19. Интеграционное тестирование
  - [~] 19.1 Написать интеграционный тест полного потока
    - Тест от нажатия горячей клавиши до копирования текста в буфер
    - Использовать моки для PyAudio и GLM API
    - Проверить все переходы состояний
    - Проверить корректность результата
    - _Requirements: 1.2, 3.1, 5.5, 6.3, 8.2_
  
  - [~] 19.2 Написать интеграционный тест восстановления после ошибок
    - Тест обработки ошибки микрофона
    - Тест обработки ошибки API
    - Тест обработки сетевой ошибки
    - Проверить возврат в IDLE после каждой ошибки
    - _Requirements: 3.6, 6.7, 6.8, 10.6_

- [ ] 20. Финальная полировка и документация
  - [~] 20.1 Создать README.md
    - Описание проекта и возможностей
    - Инструкции по установке (uv, зависимости)
    - Инструкции по настройке (.env файл, GLM_API_KEY)
    - Инструкции по запуску
    - Описание горячих клавиш и использования
    - Troubleshooting для частых проблем
  
  - [~] 20.2 Создать requirements.txt и pyproject.toml
    - Указать все зависимости с версиями
    - Настроить uv для управления виртуальным окружением
    - Добавить dev-зависимости (pytest, hypothesis)
  
  - [~] 20.3 Добавить примеры конфигурации
    - Создать .env.example с комментариями
    - Документировать все доступные параметры конфигурации
    - Добавить примеры для разных сценариев использования

- [~] 21. Финальный checkpoint - Полное тестирование
  - Запустить все unit-тесты и убедиться, что они проходят
  - Запустить все property-тесты с минимум 100 итерациями
  - Запустить интеграционные тесты
  - Проверить покрытие кода (цель: 80%+)
  - Протестировать приложение вручную на всех поддерживаемых платформах
  - Проверить обработку всех граничных случаев и ошибок
  - Спросить пользователя о готовности к релизу

## Примечания

- Все задачи являются обязательными для полного покрытия функциональности и тестирования
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoint задачи обеспечивают инкрементальную валидацию
- Property-тесты валидируют универсальные свойства корректности
- Unit-тесты валидируют конкретные примеры и граничные случаи
- Все property-тесты должны выполняться минимум с 100 итерациями
