# Implementation Plan: Active App Display

## Overview

Этот план разбивает реализацию функции Active App Display на дискретные задачи по кодированию. Функция добавляет информационную панель в нижней части плавающего окна RapidWhisper, отображающую текущее активное приложение и горячие клавиши. Реализация следует принципам кроссплатформенной расширяемости, асинхронной обработки и минимального влияния на производительность.

## Tasks

- [x] 1. Создать утилиту форматирования горячих клавиш
  - [x] 1.1 Реализовать HotkeyFormatter в utils/hotkey_formatter.py
    - Создать класс HotkeyFormatter со статическим методом format_hotkey()
    - Реализовать маппинг специальных клавиш (space → "⎵Space", enter → "↵Enter", и т.д.)
    - Реализовать маппинг модификаторов (ctrl → "Ctrl", alt → "Alt", shift → "Shift")
    - Реализовать логику форматирования функциональных клавиш (f1 → "F1")
    - Реализовать логику форматирования обычных клавиш в верхний регистр
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [x] 1.2 Написать unit тесты для HotkeyFormatter
    - Тест форматирования специальных клавиш (space, enter, esc)
    - Тест форматирования модификаторов (ctrl+a, alt+f1, shift+space)
    - Тест форматирования функциональных клавиш (f1-f12)
    - Тест форматирования обычных букв в верхний регистр
    - Тест пустой строки и невалидного ввода
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  
  - [x] 1.3 Написать property тест для форматирования модификаторов
    - **Property 5: Форматирование модификаторов**
    - **Validates: Requirements 4.1, 4.2, 4.3**
  
  - [x] 1.4 Написать property тест для форматирования клавиш
    - **Property 6: Форматирование клавиш в верхний регистр**
    - **Validates: Requirements 4.5, 4.6**

- [x] 2. Создать абстрактный базовый класс WindowMonitor
  - [x] 2.1 Реализовать WindowMonitor в services/window_monitor.py
    - Создать dataclass WindowInfo с полями (title, process_name, icon, process_id)
    - Создать абстрактный базовый класс WindowMonitor с ABC
    - Определить абстрактный метод get_active_window_info() -> Optional[WindowInfo]
    - Определить абстрактный метод start_monitoring(callback: callable) -> None
    - Определить абстрактный метод stop_monitoring() -> None
    - Реализовать фабричный метод create() для выбора реализации на основе platform.system()
    - _Requirements: 9.1, 9.2, 9.3, 9.4_
  
  - [x] 2.2 Написать unit тесты для WindowMonitor
    - Тест создания WindowInfo с корректными полями
    - Тест фабричного метода create() для Windows платформы
    - Тест фабричного метода create() для неподдерживаемых платформ
    - _Requirements: 9.1, 9.3, 9.4_
  
  - [x] 2.3 Написать property тест для выбора реализации
    - **Property 13: Выбор реализации на основе платформы**
    - **Validates: Requirements 9.3, 9.4**

- [x] 3. Реализовать WindowsWindowMonitor
  - [x] 3.1 Создать WindowsWindowMonitor в services/windows_window_monitor.py
    - Наследовать от WindowMonitor
    - Реализовать __init__ с инициализацией кэша иконок и таймера
    - Реализовать get_active_window_info() с использованием win32gui.GetForegroundWindow()
    - Реализовать извлечение заголовка окна через win32gui.GetWindowText()
    - Реализовать получение process_id через win32process.GetWindowThreadProcessId()
    - Реализовать получение имени процесса через psutil.Process()
    - Реализовать обработку ошибок (NoSuchProcess, AccessDenied)
    - _Requirements: 2.1, 2.2, 2.3, 2.5_
  
  - [x] 3.2 Реализовать извлечение иконок в WindowsWindowMonitor
    - Реализовать метод _get_window_icon() с проверкой кэша
    - Реализовать извлечение иконки через win32gui.SendMessage(WM_GETICON)
    - Реализовать fallback на win32gui.GetClassLong(GCL_HICON)
    - Реализовать извлечение иконки из exe файла через win32gui.ExtractIconEx()
    - Реализовать метод _hicon_to_qpixmap() для конвертации HICON в QPixmap
    - Реализовать метод _extract_icon_from_exe() для извлечения из исполняемого файла
    - Добавить обработку ошибок с логированием через ErrorLogger
    - _Requirements: 2.4, 2.5, 7.5_
  
  - [x] 3.3 Реализовать кэширование иконок
    - Реализовать метод _cache_icon() для добавления иконки в кэш
    - Реализовать LRU логику с отслеживанием количества обращений
    - Реализовать удаление наименее используемых записей при превышении 50 элементов
    - Реализовать проверку кэша перед извлечением новой иконки
    - _Requirements: 8.3, 8.4_
  
  - [x] 3.4 Реализовать мониторинг активного окна
    - Реализовать метод start_monitoring() с созданием QTimer
    - Установить интервал таймера 200ms
    - Реализовать метод _check_active_window() для проверки изменений
    - Реализовать вызов callback при изменении активного окна
    - Реализовать метод stop_monitoring() для остановки таймера
    - _Requirements: 1.2, 8.1_
  
  - [x] 3.5 Написать unit тесты для WindowsWindowMonitor
    - Тест получения информации об активном окне (с моками win32gui)
    - Тест обработки ошибки недоступного окна
    - Тест обработки ошибки недоступного процесса (AccessDenied)
    - Тест извлечения иконки с fallback механизмами
    - Тест возврата None при ошибке извлечения иконки
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [x] 3.6 Написать property тест для обработки ошибок
    - **Property 2: Обработка ошибок извлечения иконки**
    - **Validates: Requirements 2.5**
  
  - [x] 3.7 Написать property тест для частоты опроса
    - **Property 10: Частота опроса активного окна**
    - **Validates: Requirements 8.1**
  
  - [x] 3.8 Написать property тест для кэширования
    - **Property 12: Кэширование иконок с управлением размером**
    - **Validates: Requirements 8.3, 8.4**
  
  - [x] 3.9 Написать property тест для логирования ошибок
    - **Property 9: Логирование ошибок без прерывания работы**
    - **Validates: Requirements 7.5**

- [x] 4. Checkpoint - Проверка базовых компонентов
  - Убедиться, что все тесты для HotkeyFormatter проходят
  - Убедиться, что все тесты для WindowMonitor проходят
  - Проверить, что кэширование иконок работает корректно
  - Проверить, что обработка ошибок не прерывает работу
  - Спросить пользователя, если возникли вопросы

- [x] 5. Создать UI компонент InfoPanelWidget
  - [x] 5.1 Реализовать InfoPanelWidget в ui/info_panel_widget.py
    - Создать класс InfoPanelWidget, наследующий от QWidget
    - Реализовать __init__ с принятием config_manager
    - Реализовать метод _setup_ui() для создания layout и виджетов
    - Создать QHBoxLayout с margins (8, 6, 8, 6)
    - Создать левую часть с QLabel для иконки (20x20) и QLabel для названия
    - Создать правую часть с двумя QLabel для горячих клавиш
    - Установить фиксированную высоту 40px
    - _Requirements: 5.3, 5.4, 6.1, 6.2, 6.3, 6.4, 6.5_
  
  - [x] 5.2 Реализовать стилизацию InfoPanelWidget
    - Реализовать метод _apply_styles() для применения QSS
    - Установить темный фон (#1a1a1a) с верхней границей 1px (#333333)
    - Установить цвет основного текста #E0E0E0
    - Установить цвет вторичного текста #A0A0A0 для горячих клавиш
    - Установить шрифт Segoe UI размером 11px
    - _Requirements: 5.1, 5.2, 5.6, 5.7, 5.8_
  
  - [x] 5.3 Реализовать обновление информации о приложении
    - Реализовать метод update_app_info(window_info) с декоратором @pyqtSlot
    - Реализовать усечение названия до 30 символов с добавлением "..."
    - Реализовать масштабирование иконки до 20x20 с KeepAspectRatio
    - Реализовать отображение иконки по умолчанию при отсутствии иконки
    - Реализовать метод set_default_icon() для установки иконки по умолчанию
    - _Requirements: 1.1, 1.3, 1.4, 5.5_
  
  - [x] 5.4 Реализовать обновление горячих клавиш
    - Реализовать метод _update_record_hotkey() для чтения из config_manager
    - Использовать HotkeyFormatter.format_hotkey() для форматирования
    - Реализовать метод update_hotkey_display() для обновления при изменении конфига
    - Установить текст "Record [formatted_hotkey]" для кнопки записи
    - Установить текст "Close Esc" для кнопки закрытия
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 5.5 Написать unit тесты для InfoPanelWidget
    - Тест создания виджета с корректной структурой
    - Тест применения стилей (фон, границы, цвета)
    - Тест установки фиксированной высоты 40px
    - Тест наличия всех дочерних виджетов (иконка, название, 2 кнопки)
    - Тест отображения иконки по умолчанию при отсутствии иконки
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.6, 5.7, 5.8, 1.3_
  
  - [x] 5.6 Написать property тест для усечения названий
    - **Property 1: Усечение длинных названий приложений**
    - **Validates: Requirements 1.4**
  
  - [x] 5.7 Написать property тест для отображения горячих клавиш
    - **Property 3: Отображение горячей клавиши из конфигурации**
    - **Validates: Requirements 3.2**
  
  - [x] 5.8 Написать property тест для масштабирования иконок
    - **Property 7: Масштабирование иконок**
    - **Validates: Requirements 5.5**

- [ ] 6. Интегрировать InfoPanelWidget в FloatingWindow
  - [x] 6.1 Модифицировать FloatingWindow для добавления InfoPanelWidget
    - Импортировать InfoPanelWidget и WindowMonitor в ui/floating_window.py
    - Создать экземпляр WindowMonitor через фабричный метод
    - Создать экземпляр InfoPanelWidget с передачей config_manager
    - Добавить InfoPanelWidget в главный layout FloatingWindow (в конец)
    - Сохранить ссылки на window_monitor и info_panel как атрибуты
    - _Requirements: 7.1_
  
  - [x] 6.2 Реализовать жизненный цикл мониторинга
    - Реализовать запуск window_monitor.start_monitoring() в методе show() или showEvent()
    - Передать info_panel.update_app_info как callback в start_monitoring()
    - Реализовать остановку window_monitor.stop_monitoring() в методе hide() или closeEvent()
    - Добавить обработку ошибок с логированием
    - _Requirements: 7.3, 7.4_
  
  - [-] 6.3 Подключить обновление горячих клавиш
    - Подключить сигнал изменения конфигурации к info_panel.update_hotkey_display()
    - Если Config_Manager не имеет сигнала, создать его (config_changed)
    - Реализовать emit сигнала при изменении hotkey в Config_Manager
    - _Requirements: 3.4_
  
  - [~] 6.4 Написать unit тесты для интеграции
    - Тест добавления InfoPanelWidget в FloatingWindow
    - Тест запуска мониторинга при показе окна
    - Тест остановки мониторинга при закрытии окна
    - Тест обновления горячих клавиш при изменении конфигурации
    - _Requirements: 7.1, 7.3, 7.4, 3.4_
  
  - [~] 6.5 Написать property тест для сохранения размеров WaveformWidget
    - **Property 8: Сохранение размеров WaveformWidget**
    - **Validates: Requirements 7.2**
  
  - [~] 6.6 Написать property тест для времени отклика UI
    - **Property 4: Своевременное обновление UI**
    - **Validates: Requirements 1.2, 3.4**

- [ ] 7. Добавить зависимости и обновить документацию
  - [~] 7.1 Обновить pyproject.toml
    - Добавить pywin32 >= 306 в dependencies
    - Добавить psutil >= 5.9.0 в dependencies (если еще не добавлен)
    - Обновить версию проекта
  
  - [~] 7.2 Создать иконку по умолчанию
    - Создать или найти иконку по умолчанию для неизвестных приложений
    - Сохранить в assets/default_app_icon.png (создать папку assets если нужно)
    - Загрузить иконку в InfoPanelWidget при инициализации
  
  - [~] 7.3 Обновить README.md
    - Добавить описание новой функции Active App Display
    - Добавить скриншот панели (если возможно)
    - Обновить список зависимостей
    - Добавить примечание о поддержке только Windows (пока)

- [ ] 8. Интеграционное тестирование
  - [~] 8.1 Написать интеграционный тест полного потока
    - Тест от показа FloatingWindow до отображения информации о приложении
    - Использовать моки для win32gui API
    - Проверить, что InfoPanel обновляется при изменении активного окна
    - Проверить, что горячие клавиши отображаются корректно
    - Проверить, что мониторинг останавливается при закрытии окна
    - _Requirements: 1.1, 1.2, 3.1, 3.2, 7.3, 7.4_
  
  - [~] 8.2 Написать интеграционный тест обработки ошибок
    - Тест обработки ошибки недоступного окна
    - Тест обработки ошибки недоступного процесса
    - Тест обработки ошибки извлечения иконки
    - Проверить, что ошибки логируются
    - Проверить, что приложение продолжает работать после ошибок
    - _Requirements: 2.5, 7.5_
  
  - [~] 8.3 Написать property тест для неблокирующего извлечения иконок
    - **Property 11: Неблокирующее извлечение иконок**
    - **Validates: Requirements 8.2**

- [ ] 9. Финальный checkpoint - Полное тестирование
  - Запустить все unit тесты и убедиться, что они проходят
  - Запустить все property тесты с минимум 100 итерациями
  - Запустить интеграционные тесты
  - Протестировать функцию вручную с разными приложениями
  - Проверить производительность (частота опроса, размер кэша)
  - Проверить обработку всех граничных случаев
  - Спросить пользователя о готовности к интеграции в основную ветку

## Notes

- Все задачи являются обязательными для полного покрытия функциональности и тестирования
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoint задачи обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и граничные случаи
- Все property тесты должны выполняться минимум с 100 итерациями
- Функция пока поддерживает только Windows, но архитектура готова для расширения на другие платформы
