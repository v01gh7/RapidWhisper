# Исправления конфигурации и сообщений об ошибках

## Задача 1: Пустые промпты при первом запуске ✅ ИСПРАВЛЕНО

**Проблема**: При первом запуске .exe промпты создавались как пустые файлы.

**Решение**:
- Добавлена функция `_ensure_prompts_exist()` в `core/config_loader.py`
- Функция проверяет существование и содержимое файлов промптов
- Автоматически копирует промпты из bundle (.exe) или из исходников
- Вызывается автоматически при `create_default_configs()`
- Добавлена очистка кэша промптов при перезагрузке конфигурации

**Файлы**:
- `core/config_loader.py` - добавлена функция `_ensure_prompts_exist()`
- `RapidWhisper.spec` - добавлены `config.jsonc.example` и `secrets.json.example` в bundle

---

## Задача 2: Настройки не сохраняются ✅ ИСПРАВЛЕНО

**Проблема**: API ключи и настройки не сохранялись при запуске из .exe.

**Решение**:
- Исправлены пути в `ConfigLoader.__init__()` - теперь использует `get_config_dir()`
- Исправлены пути в `ConfigSaver.__init__()` - теперь использует `get_config_dir()`
- Исправлены пути в `ConfigSaver.save_prompt()` - теперь использует `get_config_dir()`
- Все классы теперь правильно работают в portable mode (конфиги рядом с .exe)

**Файлы**:
- `core/config_loader.py` - исправлены пути по умолчанию
- `core/config_saver.py` - исправлены пути по умолчанию

---

## Задача 3: Сообщения об ошибках ссылаются на .env ✅ ИСПРАВЛЕНО

**Проблема**: Сообщения об ошибках всё ещё ссылались на ".env файл" вместо новых JSON конфигов.

**Решение**:
- Обновлены все сообщения валидации в `core/config.py` - заменены ".env файл" на "secrets.json"
- Обновлено сообщение в `main.py` - заменено на "config.jsonc и secrets.json"
- Обновлено сообщение в `services/transcription_client.py` - заменено на "secrets.json"
- Обновлены docstrings в `core/config.py` и `ui/settings_window.py`

**Файлы**:
- `core/config.py` - обновлены сообщения валидации и docstrings
- `main.py` - обновлено сообщение об ошибке
- `services/transcription_client.py` - обновлено сообщение об ошибке GLM
- `ui/settings_window.py` - обновлен docstring класса

---

## Задача 4: API ключи не загружаются после сохранения ✅ ИСПРАВЛЕНО

**Проблема**: После сохранения API ключа в настройках, он не подхватывался при перезагрузке конфигурации.

**Причина**: В `secrets.json` были две структуры - старая (legacy) и новая. Метод `_merge_secrets()` сначала мержил новую структуру (правильно), но потом мержил старую структуру и **перезаписывал** правильные значения пустыми.

**Решение**:
- Исправлен метод `_merge_secrets()` в `core/config_loader.py`
- Legacy support теперь применяется **только если новой структуры нет**
- Обновлён `secrets.json.example` - использует только новую структуру
- Обновлена функция `_create_minimal_secrets()` - создаёт только новую структуру

**Новая структура secrets.json**:
```json
{
  "ai_provider": {
    "api_keys": {
      "groq": "",
      "openai": "",
      "glm": ""
    },
    "custom": {
      "api_key": ""
    }
  },
  "formatting": {
    "custom": {
      "api_key": ""
    }
  }
}
```

**Файлы**:
- `core/config_loader.py` - исправлен метод `_merge_secrets()`
- `secrets.json.example` - обновлена структура
- `dist/secrets.json` - очищена от legacy структуры

---

## Итоговый результат

✅ Промпты создаются и заполняются при первом запуске  
✅ Настройки сохраняются в правильную директорию (рядом с .exe)  
✅ Все сообщения об ошибках ссылаются на правильные файлы (config.jsonc, secrets.json)  
✅ API ключи корректно сохраняются и загружаются  
✅ Portable mode работает правильно  

## Тестирование

Для проверки:
1. Запустите `dist\RapidWhisper.exe`
2. Откройте настройки
3. Введите API ключ (например, Groq)
4. Нажмите "Сохранить"
5. Проверьте, что ошибка исчезла и приложение готово к работе

Все конфиги должны создаться рядом с .exe:
- `config.jsonc` - настройки приложения
- `secrets.json` - API ключи
- `config/prompts/*.txt` - промпты форматирования
- `rapidwhisper.log` - логи
